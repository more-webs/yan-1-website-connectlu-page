<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Social Media Connect</title>
<style>
  :root {
    --bg: #0d1117;
    --card-bg: #161b22;
    --text: #e6edf3;
    --accent: #58a6ff;
    --accent-hover: #1f6feb;
    --error: #f85149;
    --radius: 12px;
    font-family: "Poppins", sans-serif;
  }

  body {
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }

  header {
    width: 100%;
    background: var(--card-bg);
    display: flex;
    justify-content: space-around;
    padding: 1rem 0;
    position: sticky;
    top: 0;
    box-shadow: 0 2px 8px rgba(255,255,255,0.1);
    z-index: 10;
  }

  header button {
    background: var(--accent);
    border: none;
    color: white;
    padding: .7rem 1.5rem;
    border-radius: var(--radius);
    font-size: 1rem;
    cursor: pointer;
    transition: .2s;
  }

  header button:hover {
    background: var(--accent-hover);
  }

  main {
    width: 90%;
    max-width: 500px;
    margin-top: 2rem;
  }

  .page { display: none; }
  .page.active { display: block; animation: fadeIn .3s ease-in; }

  form {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  input, textarea, select {
    padding: .8rem;
    border-radius: var(--radius);
    border: none;
    outline: none;
    background: #21262d;
    color: var(--text);
    font-size: 1rem;
  }

  textarea { resize: none; }

  button.post, button.ok {
    background: var(--accent);
    border: none;
    padding: .8rem;
    border-radius: var(--radius);
    font-size: 1.1rem;
    cursor: pointer;
    transition: .2s;
  }

  button.post:hover, button.ok:hover { background: var(--accent-hover); }

  .profile-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    margin-top: 2rem;
    box-shadow: 0 0 20px rgba(88,166,255,0.3);
    animation: pop .4s ease-in-out;
  }

  .profile-card h2 { color: var(--accent); }

  .profile-links a {
    display: block;
    color: var(--accent);
    margin: .3rem 0;
    text-decoration: none;
    transition: .2s;
  }

  .profile-links a:hover { color: var(--accent-hover); }

  @keyframes fadeIn {
    from {opacity:0; transform: translateY(10px);}
    to   {opacity:1; transform: translateY(0);}
  }

  @keyframes pop {
    0%   {transform:scale(.9); opacity:0;}
    100% {transform:scale(1); opacity:1;}
  }
</style>
</head>
<body>
  <header>
    <button id="uploadBtn">Upload</button>
    <button id="connectBtn">Connect</button>
  </header>

  <main>
    <!-- Upload Page -->
    <div id="uploadPage" class="page active">
      <form id="uploadForm">
        <h2>Upload Profile</h2>

        <input type="text" id="name" placeholder="Name" required />

        <select id="gender_upload" required>
          <option value="">Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>

        <textarea id="bio" maxlength="30" placeholder="Bio (max 30 chars)" required></textarea>

        <!-- Platform 1 (Required) -->
        <input type="text" id="platform_1_name" placeholder="Platform 1 Name" required />
        <input type="url" id="platform_1_link" placeholder="Platform 1 Link" required />

        <!-- Platform 2 (Optional) -->
        <input type="text" id="platform_2_name" placeholder="Platform 2 Name" />
        <input type="url" id="platform_2_link" placeholder="Platform 2 Link" />

        <!-- Platform 3 (Optional) -->
        <input type="text" id="platform_3_name" placeholder="Platform 3 Name" />
        <input type="url" id="platform_3_link" placeholder="Platform 3 Link" />

        <label for="d_line">Disappear Date:</label>
        <input type="date" id="d_line" required />

        <button type="submit" class="post">Post</button>
      </form>
    </div>

    <!-- Connect Page -->
    <div id="connectPage" class="page">
      <form id="connectForm">
        <h2>Connect</h2>
        <select id="gender" required>
          <option value="">Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <button type="submit" class="ok">OK</button>
      </form>
      <div id="profileDisplay"></div>
    </div>
  </main>

  <script>
    /* --------------------------------------------------------------
       UI navigation
       -------------------------------------------------------------- */
    const uploadBtn   = document.getElementById('uploadBtn');
    const connectBtn  = document.getElementById('connectBtn');
    const uploadPage = document.getElementById('uploadPage');
    const connectPage= document.getElementById('connectPage');
    const uploadForm = document.getElementById('uploadForm');
    const connectForm= document.getElementById('connectForm');
    const profileDisplay = document.getElementById('profileDisplay');

    uploadBtn.onclick = () => {
      uploadPage.classList.add('active');
      connectPage.classList.remove('active');
    };
    connectBtn.onclick = () => {
      connectPage.classList.add('active');
      uploadPage.classList.remove('active');
    };

    /* --------------------------------------------------------------
       Date picker – limit to today + 7 days
       -------------------------------------------------------------- */
    const dateInput = document.getElementById('d_line');
    const today = new Date();
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 7);
    dateInput.min = today.toISOString().split('T')[0];
    dateInput.max = maxDate.toISOString().split('T')[0];

    /* --------------------------------------------------------------
       Helper to safely call Android bridge if it exists
       -------------------------------------------------------------- */
    function callAndroidMethod(method, arg) {
      if (window.Android && typeof Android[method] === 'function') {
        if (arg !== undefined) Android[method](arg);
        else Android[method]();
      }
    }

    /* --------------------------------------------------------------
       UPLOAD – after a *successful* post we fire a rewarded ad
       -------------------------------------------------------------- */
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const body = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender_upload').value,
        bio: document.getElementById('bio').value,
        platform_1_name: document.getElementById('platform_1_name').value,
        platform_1_link: document.getElementById('platform_1_link').value,
        platform_2_name: document.getElementById('platform_2_name').value,
        platform_2_link: document.getElementById('platform_2_link').value,
        platform_3_name: document.getElementById('platform_3_name').value,
        platform_3_link: document.getElementById('platform_3_link').value,
        d_line: document.getElementById('d_line').value,
      };

      try {
        const res = await fetch('https://social_media_connect_backend.ecethre.workers.dev/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();

        if (data.success) {
          alert('Profile uploaded successfully!');

          /* ----- PLAY REWARDED AD ----- */
          callAndroidMethod('requestRewardedAd', 'upload');

          uploadForm.reset();
        } else {
          alert('Error: ' + (data.error || 'Something went wrong'));
        }
      } catch (err) {
        alert('Network Error: ' + err.message);
      }
    });

    /* --------------------------------------------------------------
       CONNECT – count OK‑clicks, show ad every 5th click
       -------------------------------------------------------------- */
    let okClickCount = 0;

    connectForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      okClickCount++;
      if (okClickCount >= 5) {
        // fire ad and reset counter
        callAndroidMethod('requestRewardedAd', 'connect');
        okClickCount = 0;
      }

      const gender = document.getElementById('gender').value;
      profileDisplay.innerHTML = '<p>Loading...</p>';

      try {
        const res = await fetch(
          `https://social_media_connect_backend.ecethre.workers.dev/random?gender=${encodeURIComponent(gender)}`
        );
        const json = await res.json();

        if (json.error) {
          profileDisplay.innerHTML = `<p style="color:var(--error)">${json.error}</p>`;
          return;
        }

        profileDisplay.innerHTML = `
          <div class="profile-card" style="border-left:5px solid ${
            json.gender === 'male' ? '#1f6feb' : '#ff79c6'
          };">
            <h2>${json.name || 'Unknown'}</h2>
            <p><strong>Gender:</strong> ${json.gender || 'N/A'}</p>
            <p>${json.bio || ''}</p>

            <div class="profile-links">
              ${json.platform_1_name ? `<a href="${json.platform_1_link}" target="_blank">${json.platform_1_name}</a>` : ''}
              ${json.platform_2_name ? `<a href="${json.platform_2_link}" target="_blank">${json.platform_2_name}</a>` : ''}
              ${json.platform_3_name ? `<a href="${json.platform_3_link}" target="_blank">${json.platform_3_name}</a>` : ''}
            </div>

            <p style="margin-top:1rem;font-size:0.9rem;color:#999;">
              Disappear Date: ${json.d_line || 'N/A'}
            </p>
          </div>
        `;
      } catch (err) {
        profileDisplay.innerHTML = `<p style="color:var(--error)">Network error: ${err.message}</p>`;
      }
    });

    /* --------------------------------------------------------------
       AD‑related callbacks – called from native code
       -------------------------------------------------------------- */
    function onAdPreloaded() {
      console.log('✅ Rewarded ad pre‑loaded');
    }
    function onAdFailedToPreload() {
      console.warn('⚠️ Rewarded ad failed to preload');
    }
    function onAdNotAvailable() {
      console.warn('⚠️ Rewarded ad not available');
    }
    function onAdCompleted(target) {
      console.log('✅ Rewarded ad completed – target:', target);
    }

    /* --------------------------------------------------------------
       Pre‑load the first rewarded ad when the page loads (Android only)
       -------------------------------------------------------------- */
    if (window.Android && typeof Android.preloadRewardedAd === 'function') {
      Android.preloadRewardedAd();
    }
  </script>
</body>
</html>
