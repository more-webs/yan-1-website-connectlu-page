<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Social Media Connect</title>
<style>
  :root {
    --bg: #0d1117;
    --card-bg: #161b22;
    --text: #e6edf3;
    --accent: #58a6ff;
    --accent-hover: #1f6feb;
    --error: #f85149;
    --radius: 12px;
    font-family: "Poppins", sans-serif;
  }

  body {
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    position: relative;
  }

  header {
    width: 100%;
    background: var(--card-bg);
    display: flex;
    justify-content: space-around;
    padding: 1rem 0;
    position: sticky;
    top: 0;
    box-shadow: 0 2px 8px rgba(255,255,255,0.1);
    z-index: 10;
  }

  header button {
    background: var(--accent);
    border: none;
    color: white;
    padding: .7rem 1.5rem;
    border-radius: var(--radius);
    font-size: 1rem;
    cursor: pointer;
    transition: .2s;
  }

  header button:hover {
    background: var(--accent-hover);
  }

  main {
    width: 90%;
    max-width: 500px;
    margin-top: 2rem;
  }

  .page { display: none; }
  .page.active { display: block; animation: fadeIn .3s ease-in; }

  form {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  input, textarea, select {
    padding: .8rem;
    border-radius: var(--radius);
    border: none;
    outline: none;
    background: #21262d;
    color: var(--text);
    font-size: 1rem;
  }

  textarea { resize: none; }

  button.post, button.ok, button.cloudinary-upload {
    background: var(--accent);
    border: none;
    padding: .8rem;
    border-radius: var(--radius);
    font-size: 1.1rem;
    cursor: pointer;
    transition: .2s;
    margin-top: 0.5rem;
  }

  button.post:hover, button.ok:hover, button.cloudinary-upload:hover { 
    background: var(--accent-hover); 
  }

  .profile-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 1rem;
    display: none;
  }

  .profile-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    margin-top: 2rem;
    box-shadow: 0 0 20px rgba(88,166,255,0.3);
    animation: pop .4s ease-in-out;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    align-items: start;
    text-align: left;
    position: relative;
  }

  .profile-card img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    justify-self: center;
  }

  .profile-card h2 { 
    color: var(--accent); 
    margin: 0; 
    font-size: 1.5rem;
  }

  .profile-links a {
    display: block;
    color: var(--accent);
    margin: .3rem 0;
    text-decoration: none;
    transition: .2s;
    font-size: 1rem;
  }

  .profile-links a:hover { color: var(--accent-hover); }

  .website-title {
    font-size: 2rem;
    font-weight: bold;
    margin-top: 1rem;
    text-align: center;
    color: var(--accent);
  }

  .tagline {
    font-size: 0.9rem;
    margin: 0.5rem auto 1rem;
    text-align: center;
    max-width: 80%;
    background: linear-gradient(90deg, #ff79c6, #50fa7b, #8be9fd, #bd93f9);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: shine 3s infinite alternate;
  }

  @keyframes shine {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }

  footer {
    margin-top: auto;
    padding: 1rem;
    text-align: center;
    font-size: 0.8rem;
    color: #8b949e;
    width: 100%;
  }

  .floating-chat {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: var(--accent);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 100;
  }

  .popup-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .popup-content {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: var(--radius);
    max-width: 90%;
    text-align: center;
    animation: pop .3s ease-out;
  }

  .fullscreen-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: flex;
    flex-direction: column;
  }

  .fullscreen-header {
    padding: 1rem;
    background: var(--card-bg);
    display: flex;
    justify-content: flex-end;
  }

  .close-fullscreen {
    background: var(--error);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1rem;
  }

  .fullscreen-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: auto;
    padding: 20px;
  }

  .fullscreen-image {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
  }

  .fullscreen-image.zoomed {
    transform: scale(2);
    cursor: zoom-out;
  }

  .bio-text {
    font-size: 1rem;
    line-height: 1.5;
    margin: 0.5rem 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .platform-select {
    width: 100%;
    padding: 0.8rem;
    border-radius: var(--radius);
    border: none;
    outline: none;
    background: #21262d;
    color: var(--text);
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }

  .error-message {
    color: var(--error);
    font-size: 0.9rem;
    margin-top: 0.3rem;
    display: none;
  }

  /* Home Icon Styles */
  .home-icon {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 24px;
    text-decoration: none;
    color: var(--accent);
    z-index: 20;
    transition: color 0.2s;
  }

  .home-icon:hover {
    color: var(--accent-hover);
  }

  @keyframes fadeIn {
    from {opacity:0; transform: translateY(10px);}
    to   {opacity:1; transform: translateY(0);}
  }

  @keyframes pop {
    0%   {transform:scale(.9); opacity:0;}
    100% {transform:scale(1); opacity:1;}
  }
</style>
</head>
<body>
  <!-- Home Icon -->
  <a href="https://yan-shun-081.github.io/yan-1-website.com/" class="home-icon" title="Home">üè†</a>

  <div class="website-title">ConnectLu</div>
  <div class="tagline">
    Connection starts with trust. Connectlu is built to respect personal boundaries while opening doors to genuine human connections‚Äîshared only when you're comfortable.
  </div>

  <header>
    <button id="uploadBtn">Upload</button>
    <button id="connectBtn">Connect</button>
  </header>

  <main>
    <!-- Upload Page -->
    <div id="uploadPage" class="page active">
      <form id="uploadForm">
        <h2>Upload Profile</h2>
        
        <img id="profilePreview" class="profile-preview" alt="Profile Preview" />

        <button type="button" id="uploadProfilePic" class="cloudinary-upload">Upload Profile Picture</button>

        <input type="hidden" id="secure_url" name="secure_url" />
        <input type="hidden" id="public_id" name="public_id" />

        <input type="text" id="name" placeholder="Name" required />

        <select id="gender_upload" required>
          <option value="">Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>

        <textarea id="bio" maxlength="100" placeholder="Bio (max 100 chars)" required></textarea>

        <!-- Platform 1 (Required) -->
        <select id="platform_1_name" class="platform-select" required>
          <option value="">Select Platform 1</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="telegram">Telegram</option>
          <option value="facebook">Facebook</option>
          <option value="instagram">Instagram</option>
          <option value="linkedin">LinkedIn</option>
          <option value="snapchat">Snapchat</option>
          <option value="github">GitHub</option>
          <option value="archive">Archive.org</option>
        </select>
        <input type="url" id="platform_1_link" placeholder="Platform 1 Link" required />
        <div id="platform_1_error" class="error-message">Please enter a valid link for this platform</div>

        <!-- Platform 2 (Required) -->
        <select id="platform_2_name" class="platform-select" required>
          <option value="">Select Platform 2</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="telegram">Telegram</option>
          <option value="facebook">Facebook</option>
          <option value="instagram">Instagram</option>
          <option value="linkedin">LinkedIn</option>
          <option value="snapchat">Snapchat</option>
          <option value="github">GitHub</option>
          <option value="archive">Archive.org</option>
        </select>
        <input type="url" id="platform_2_link" placeholder="Platform 2 Link" required />
        <div id="platform_2_error" class="error-message">Please enter a valid link for this platform</div>

        <!-- Platform 3 (Optional) -->
        <select id="platform_3_name" class="platform-select">
          <option value="">Select Platform 3 (Optional)</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="telegram">Telegram</option>
          <option value="facebook">Facebook</option>
          <option value="instagram">Instagram</option>
          <option value="linkedin">LinkedIn</option>
          <option value="snapchat">Snapchat</option>
          <option value="github">GitHub</option>
          <option value="archive">Archive.org</option>
        </select>
        <input type="url" id="platform_3_link" placeholder="Platform 3 Link" />
        <div id="platform_3_error" class="error-message">Please enter a valid link for this platform</div>

        <label for="d_line">Disappear Date:</label>
        <input type="date" id="d_line" required />

        <button type="submit" class="post">Post</button>
      </form>
    </div>

    <!-- Connect Page -->
    <div id="connectPage" class="page">
      <form id="connectForm">
        <h2>Connect</h2>
        <select id="gender" required>
          <option value="">Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        <button type="submit" class="ok">OK</button>
      </form>
      <div id="profileDisplay"></div>
    </div>
  </main>

  <footer>
    ¬© 2026 ConnectLu ¬∑ Built with ‚ù§Ô∏è by YAN
  </footer>

  <div class="floating-chat" id="chatIcon">üí¨</div>

  <!-- Cloudinary Upload Widget Script -->
  <script src="https://upload-widget.cloudinary.com/latest/global/all.js" type="text/javascript"></script>

  <script>
    /* --------------------------------------------------------------
       UI navigation
       -------------------------------------------------------------- */
    const uploadBtn   = document.getElementById('uploadBtn');
    const connectBtn  = document.getElementById('connectBtn');
    const uploadPage = document.getElementById('uploadPage');
    const connectPage= document.getElementById('connectPage');
    const uploadForm = document.getElementById('uploadForm');
    const connectForm= document.getElementById('connectForm');
    const profileDisplay = document.getElementById('profileDisplay');
    const profilePreview = document.getElementById('profilePreview');
    const secureUrlInput = document.getElementById('secure_url');
    const publicIdInput = document.getElementById('public_id');
    const chatIcon = document.getElementById('chatIcon');

    uploadBtn.onclick = () => {
      uploadPage.classList.add('active');
      connectPage.classList.remove('active');
    };
    connectBtn.onclick = () => {
      connectPage.classList.add('active');
      uploadPage.classList.remove('active');
    };

    /* --------------------------------------------------------------
       Date picker ‚Äì limit to today + 7 days
       -------------------------------------------------------------- */
    const dateInput = document.getElementById('d_line');
    const today = new Date();
    const maxDate = new Date();
    maxDate.setDate(today.getDate() + 7);
    dateInput.min = today.toISOString().split('T')[0];
    dateInput.max = maxDate.toISOString().split('T')[0];

    /* --------------------------------------------------------------
       Cloudinary Upload Widget
       -------------------------------------------------------------- */
    document.getElementById('uploadProfilePic').addEventListener('click', function() {
      const widget = cloudinary.createUploadWidget({
        cloudName: 'dtnxo8dox',
        uploadPreset: 's9gdgu7t',
        sources: ['local', 'url', 'camera'],
        cropping: true,
        croppingAspectRatio: 1,
        showSkipCropButton: false,
        croppingCoordinatesMode: 'custom',
        multiple: false,
        maxFiles: 1,
        maxImageFileSize: 3000000, // 3MB
        clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif']
      }, (error, result) => {
        if (!error && result && result.event === 'success') {
          // Store the secure_url and public_id
          secureUrlInput.value = result.info.secure_url;
          publicIdInput.value = result.info.public_id;
          
          // Show preview
          profilePreview.src = result.info.secure_url;
          profilePreview.style.display = 'block';
        } else if (error) {
          console.error('Cloudinary Upload Error:', error);
          alert('Upload failed. Please try again.');
        }
      });

      widget.open();
    });

    /* --------------------------------------------------------------
       Platform URL validation
       -------------------------------------------------------------- */
    const platformDomains = {
      'whatsapp': ['whatsapp.com'],
      'telegram': ['t.me', 'telegram.me'],
      'facebook': ['facebook.com', 'fb.com'],
      'instagram': ['instagram.com'],
      'linkedin': ['linkedin.com'],
      'snapchat': ['snapchat.com'],
      'github': ['github.com'],
      'archive': ['archive.org']
    };

    function validatePlatformUrl(platform, url) {
      if (!url || url.trim() === '') return true; // Allow empty for optional fields
      if (!platform || platform === '') return false;
      
      const domains = platformDomains[platform];
      if (!domains) return false;
      
      try {
        const urlObj = new URL(url);
        return domains.some(domain => 
          urlObj.hostname === domain || urlObj.hostname.endsWith('.' + domain)
        );
      } catch (e) {
        return false;
      }
    }

    function validatePlatformFields() {
      let isValid = true;
      
      // Validate platform 1
      const platform1Name = document.getElementById('platform_1_name').value;
      const platform1Link = document.getElementById('platform_1_link').value;
      const platform1Error = document.getElementById('platform_1_error');
      
      if (!validatePlatformUrl(platform1Name, platform1Link)) {
        platform1Error.style.display = 'block';
        isValid = false;
      } else {
        platform1Error.style.display = 'none';
      }
      
      // Validate platform 2
      const platform2Name = document.getElementById('platform_2_name').value;
      const platform2Link = document.getElementById('platform_2_link').value;
      const platform2Error = document.getElementById('platform_2_error');
      
      if (!validatePlatformUrl(platform2Name, platform2Link)) {
        platform2Error.style.display = 'block';
        isValid = false;
      } else {
        platform2Error.style.display = 'none';
      }
      
      // Validate platform 3 (optional)
      const platform3Name = document.getElementById('platform_3_name').value;
      const platform3Link = document.getElementById('platform_3_link').value;
      const platform3Error = document.getElementById('platform_3_error');
      
      if (platform3Name && platform3Link && !validatePlatformUrl(platform3Name, platform3Link)) {
        platform3Error.style.display = 'block';
        isValid = false;
      } else {
        platform3Error.style.display = 'none';
      }
      
      return isValid;
    }

    // Add event listeners for real-time validation
    document.getElementById('platform_1_name').addEventListener('change', validatePlatformFields);
    document.getElementById('platform_1_link').addEventListener('input', validatePlatformFields);
    document.getElementById('platform_2_name').addEventListener('change', validatePlatformFields);
    document.getElementById('platform_2_link').addEventListener('input', validatePlatformFields);
    document.getElementById('platform_3_name').addEventListener('change', validatePlatformFields);
    document.getElementById('platform_3_link').addEventListener('input', validatePlatformFields);

    /* --------------------------------------------------------------
       Helper to safely call Android bridge if it exists
       -------------------------------------------------------------- */
    function callAndroidMethod(method, arg) {
      if (window.Android && typeof Android[method] === 'function') {
        if (arg !== undefined) Android[method](arg);
        else Android[method]();
      }
    }

    /* --------------------------------------------------------------
       UPLOAD ‚Äì after a *successful* post we fire a rewarded ad
       -------------------------------------------------------------- */
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validate platform fields
      if (!validatePlatformFields()) {
        alert('Please fix the platform link errors before submitting.');
        return;
      }

      const body = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender_upload').value,
        bio: document.getElementById('bio').value,
        platform_1_name: document.getElementById('platform_1_name').value,
        platform_1_link: document.getElementById('platform_1_link').value,
        platform_2_name: document.getElementById('platform_2_name').value,
        platform_2_link: document.getElementById('platform_2_link').value,
        platform_3_name: document.getElementById('platform_3_name').value,
        platform_3_link: document.getElementById('platform_3_link').value,
        d_line: document.getElementById('d_line').value,
        secure_url: secureUrlInput.value,
        public_id: publicIdInput.value
      };

      try {
        const res = await fetch('https://social_media_connect_backend.ecethre.workers.dev/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();

        if (data.success) {
          alert('Profile uploaded successfully!');

          /* ----- PLAY REWARDED AD ----- */
          callAndroidMethod('requestRewardedAd', 'upload');

          uploadForm.reset();
          profilePreview.style.display = 'none';
          secureUrlInput.value = '';
          publicIdInput.value = '';
          
          // Reset error messages
          document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        } else {
          alert('Error: ' + (data.error || 'Something went wrong'));
        }
      } catch (err) {
        alert('Network Error: ' + err.message);
      }
    });

    /* --------------------------------------------------------------
       Preload all profiles when "Connect" is clicked
       -------------------------------------------------------------- */
    let allProfiles = [];

    connectBtn.addEventListener('click', async () => {
      try {
        const res = await fetch('https://social_media_connect_backend.ecethre.workers.dev/all');
        const data = await res.json();
        allProfiles = data.profiles || [];
        localStorage.setItem('connectlu_profiles', JSON.stringify(allProfiles));
      } catch (err) {
        console.warn('Failed to load profiles:', err);
        allProfiles = JSON.parse(localStorage.getItem('connectlu_profiles')) || [];
      }
    });

    /* --------------------------------------------------------------
       Fullscreen view functionality
       -------------------------------------------------------------- */
    function openFullscreen(url) {
      const overlay = document.createElement('div');
      overlay.className = 'fullscreen-overlay';
      
      overlay.innerHTML = `
        <div class="fullscreen-header">
          <button class="close-fullscreen">‚úï Close</button>
        </div>
        <div class="fullscreen-container">
          <img src="${url}" class="fullscreen-image" alt="Profile Image">
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const image = overlay.querySelector('.fullscreen-image');
      let isZoomed = false;
      
      image.addEventListener('click', () => {
        isZoomed = !isZoomed;
        if (isZoomed) {
          image.classList.add('zoomed');
        } else {
          image.classList.remove('zoomed');
        }
      });
      
      overlay.querySelector('.close-fullscreen').addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
    }

    /* --------------------------------------------------------------
       CONNECT ‚Äì show random profile from local storage
       -------------------------------------------------------------- */
    connectForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const gender = document.getElementById('gender').value;
      const filtered = allProfiles.filter(p => p.gender === gender);

      if (filtered.length === 0) {
        profileDisplay.innerHTML = `<p style="color:var(--error)">No profiles found for selected gender.</p>`;
        return;
      }

      const randomProfile = filtered[Math.floor(Math.random() * filtered.length)];

      // Create platform links HTML
      let platformLinksHTML = '';
      if (randomProfile.platform_1_name && randomProfile.platform_1_link) {
        platformLinksHTML += `<a href="${randomProfile.platform_1_link}" target="_blank">${randomProfile.platform_1_name}</a>`;
      }
      if (randomProfile.platform_2_name && randomProfile.platform_2_link) {
        platformLinksHTML += `<a href="${randomProfile.platform_2_link}" target="_blank">${randomProfile.platform_2_name}</a>`;
      }
      if (randomProfile.platform_3_name && randomProfile.platform_3_link) {
        platformLinksHTML += `<a href="${randomProfile.platform_3_link}" target="_blank">${randomProfile.platform_3_name}</a>`;
      }

      profileDisplay.innerHTML = `
        <div class="profile-card" style="border-left:5px solid ${
          randomProfile.gender === 'male' ? '#1f6feb' : '#ff79c6'
        };">
          ${randomProfile.secure_url ? `
            <div style="position: relative;">
              <img src="${randomProfile.secure_url}" alt="Profile">
              <button class="fullscreen-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;" title="View Fullscreen">‚õ∂</button>
            </div>
          ` : ''}
          <div>
            <h2>${randomProfile.name || 'Unknown'}</h2>
            <p><strong>Gender:</strong> ${randomProfile.gender || 'N/A'}</p>
            <p class="bio-text">${randomProfile.bio || ''}</p>

            <div class="profile-links">
              ${platformLinksHTML}
            </div>

            <p style="margin-top:1rem;font-size:0.9rem;color:#999;">
              Disappear Date: ${randomProfile.d_line || 'N/A'}
            </p>
          </div>
        </div>
      `;
      
      // Add fullscreen event listener if image exists
      if (randomProfile.secure_url) {
        profileDisplay.querySelector('.fullscreen-btn').addEventListener('click', () => {
          openFullscreen(randomProfile.secure_url);
        });
      }
    });

    /* --------------------------------------------------------------
       Feedback Popup Logic
       -------------------------------------------------------------- */
    chatIcon.addEventListener('click', () => {
      const popup = document.createElement('div');
      popup.className = 'popup-overlay';
      popup.innerHTML = `
        <div class="popup-content">
          <h3>üîê Login or sign up with GitHub to give feedback.</h3>
          <p>üì∫ Or click the video link <a href="https://archive.org/details/panfda" target="_blank">here</a> to know how to give feedback.</p>
          <p>Redirecting in <span id="countdown">5</span> seconds...</p>
        </div>
      `;
      document.body.appendChild(popup);

      let count = 5;
      const countdownEl = popup.querySelector('#countdown');
      const interval = setInterval(() => {
        count--;
        countdownEl.textContent = count;
        if (count <= 0) {
          clearInterval(interval);
          popup.remove();
          window.open('https://github.com/OpenThoughtVoice/OpenThoughtVoice/discussions/9', '_blank');
        }
      }, 1000);
    });

    /* --------------------------------------------------------------
       AD‚Äërelated callbacks ‚Äì called from native code
       -------------------------------------------------------------- */
    function onAdPreloaded() {
      console.log('‚úÖ Rewarded ad pre‚Äëloaded');
    }
    function onAdFailedToPreload() {
      console.warn('‚ö†Ô∏è Rewarded ad failed to preload');
    }
    function onAdNotAvailable() {
      console.warn('‚ö†Ô∏è Rewarded ad not available');
    }
    function onAdCompleted(target) {
      console.log('‚úÖ Rewarded ad completed ‚Äì target:', target);
    }

    /* --------------------------------------------------------------
       Pre‚Äëload the first rewarded ad when the page loads (Android only)
       -------------------------------------------------------------- */
    if (window.Android && typeof Android.preloadRewardedAd === 'function') {
      Android.preloadRewardedAd();
    }
  </script>
</body>
</html>
